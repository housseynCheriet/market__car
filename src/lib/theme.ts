export const LIGHT_THEMES: Record<string, Record<string, string>> = {
  'Light Blue': {
    '--primary-bg-color': '#ffffff',
    '--secondary-bg-color': '#f8fafc',
    '--text-color': '#0f172a',
    '--heading-color': '#0b1220',
    '--accent-color': '#2563eb',
    '--accent-hover-color': '#1d4ed8',
    '--accent-light-color': '#dbeafe',
    '--border-color': '#e6e9ee',
    '--shadow-color': '16 24 40',
    '--link-color': '#2563eb',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#f1f5f9',
    '--success-color': '#16a34a',
    '--warning-color': '#f59e0b',
    '--error-color': '#dc2626',
    '--info-color': '#0284c7',
    '--overlay-color': 'rgba(15, 23, 42, 0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#ffffff',
    '--input-bg-color': '#ffffff',
    '--input-border-hover-color': '#cbd5e1',
  },
  'Soft Rose': {
    '--primary-bg-color': '#fffafb',
    '--secondary-bg-color': '#fff1f2',
    '--text-color': '#2a2730',
    '--heading-color': '#1f1b22',
    '--accent-color': '#db2777',
    '--accent-hover-color': '#be185d',
    '--accent-light-color': '#fce7f3',
    '--border-color': '#fde8ef',
    '--shadow-color': '22 12 28',
    '--link-color': '#db2777',
    '--disabled-color': '#a1a1aa',
    '--disabled-bg-color': '#f5f3f4',
    '--success-color': '#16a34a',
    '--warning-color': '#f59e0b',
    '--error-color': '#dc2626',
    '--info-color': '#0284c7',
    '--overlay-color': 'rgba(45, 12, 30, 0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#fffafb',
    '--input-bg-color': '#ffffff',
    '--input-border-hover-color': '#fbcfe8',
  },
  'Green Calm': {
    '--primary-bg-color': '#fbfefb',
    '--secondary-bg-color': '#f0fdf4',
    '--text-color': '#06351e',
    '--heading-color': '#042a16',
    '--accent-color': '#059669',
    '--accent-hover-color': '#047857',
    '--accent-light-color': '#dcfce7',
    '--border-color': '#dff6ea',
    '--shadow-color': '10 34 18',
    '--link-color': '#059669',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#f1f5f9',
    '--success-color': '#16a34a',
    '--warning-color': '#f59e0b',
    '--error-color': '#dc2626',
    '--info-color': '#0284c7',
    '--overlay-color': 'rgba(10, 34, 18, 0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#ffffff',
    '--input-bg-color': '#ffffff',
    '--input-border-hover-color': '#bbf7d0',
  },
  'Amber Warm': {
    '--primary-bg-color': '#fffbf0',
    '--secondary-bg-color': '#fff7ed',
    '--text-color': '#3b2f0b',
    '--heading-color': '#231a07',
    '--accent-color': '#d97706',
    '--accent-hover-color': '#b45309',
    '--accent-light-color': '#fef3c7',
    '--border-color': '#f6e6c2',
    '--shadow-color': '28 20 12',
    '--link-color': '#b45309',
    '--disabled-color': '#a8a29e',
    '--disabled-bg-color': '#f5f5f4',
    '--success-color': '#16a34a',
    '--warning-color': '#f59e0b',
    '--error-color': '#dc2626',
    '--info-color': '#0284c7',
    '--overlay-color': 'rgba(59, 47, 11, 0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#ffffff',
    '--input-bg-color': '#ffffff',
    '--input-border-hover-color': '#fcd34d',
  },
  'White': {
    '--primary-bg-color': '#ffffff',
    '--secondary-bg-color': '#ffffff',
    '--text-color': '#0b1220',
    '--heading-color': '#020617',
    '--accent-color': '#2563eb',
    '--accent-hover-color': '#1d4ed8',
    '--accent-light-color': '#dbeafe',
    '--border-color': '#e6e9ee',
    '--shadow-color': '16 24 40',
    '--link-color': '#2563eb',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#f1f5f9',
    '--success-color': '#16a34a',
    '--warning-color': '#f59e0b',
    '--error-color': '#dc2626',
    '--info-color': '#0284c7',
    '--overlay-color': 'rgba(15, 23, 42, 0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#ffffff',
    '--input-bg-color': '#ffffff',
    '--input-border-hover-color': '#cbd5e1',
  },
  'White Tiny': {
    '--primary-bg-color': '#ffffff',
    '--secondary-bg-color': '#fefefe',
    '--text-color': '#0f172a',
    '--heading-color': '#071126',
    '--accent-color': '#1e40af',
    '--accent-hover-color': '#1e3a8a',
    '--accent-light-color': '#e0e7ff',
    '--border-color': '#f3f4f6',
    '--shadow-color': '14 20 36',
    '--link-color': '#1e40af',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#f1f5f9',
    '--success-color': '#16a34a',
    '--warning-color': '#f59e0b',
    '--error-color': '#dc2626',
    '--info-color': '#0284c7',
    '--overlay-color': 'rgba(7, 17, 38, 0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#ffffff',
    '--input-bg-color': '#ffffff',
    '--input-border-hover-color': '#cbd5e1',
  },
  'Coral Morning (فجر المرجان)': {
    '--primary-bg-color': '#b7bbc9',
    '--secondary-bg-color': '#9fa6ba',
    '--text-color': '#0b1220',
    '--heading-color': '#071126',
    '--accent-color': '#ff6b4d',
    '--accent-hover-color': '#e85b3c',
    '--accent-light-color': '#ffd5cc',
    '--border-color': '#8f97a8',
    '--shadow-color': '16 24 40',
    '--link-color': '#ff8a7a',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#e2e8f0',
    '--success-color': '#16a34a',
    '--warning-color': '#f59e0b',
    '--error-color': '#dc2626',
    '--info-color': '#0284c7',
    '--overlay-color': 'rgba(15, 23, 42, 0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#ffffff',
    '--input-bg-color': '#ffffff',
    '--input-border-hover-color': '#cbd5e1',
  },
  'Coral Breeze (نسيم المرجان)': {
    '--primary-bg-color': '#eaf0f6',
    '--secondary-bg-color': '#d6dce6',
    '--text-color': '#0b1220',
    '--heading-color': '#071126',
    '--accent-color': '#ff6347',
    '--accent-hover-color': '#e85b3c',
    '--accent-light-color': '#ffd5cc',
    '--border-color': '#c7cfe0',
    '--shadow-color': '16 24 40',
    '--link-color': '#ff7a66',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#f1f5f9',
    '--success-color': '#16a34a',
    '--warning-color': '#f59e0b',
    '--error-color': '#dc2626',
    '--info-color': '#0284c7',
    '--overlay-color': 'rgba(15, 23, 42, 0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#ffffff',
    '--input-bg-color': '#ffffff',
    '--input-border-hover-color': '#cbd5e1',
  }
};

export const DARK_THEMES: Record<string, Record<string, string>> = {
  'Night Indigo': {
    '--primary-bg-color': '#0b1220',
    '--secondary-bg-color': '#1e2937',
    '--text-color': '#f8fafc',
    '--heading-color': '#ffffff',
    '--accent-color': '#a78bfa',
    '--accent-hover-color': '#9b6ff9',
    '--accent-light-color': '#c4b5fd',
    '--border-color': '#475569',
    '--shadow-color': '0 0 0',
    '--link-color': '#c4b5fd',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#334155',
    '--success-color': '#4ade80',
    '--warning-color': '#fbbf24',
    '--error-color': '#f87171',
    '--info-color': '#60a5fa',
    '--overlay-color': 'rgba(0,0,0,0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#1e2937',
    '--input-bg-color': '#0f1724',
    '--input-border-hover-color': '#64748b',
  },
  'Deep Teal': {
    '--primary-bg-color': '#021f20',
    '--secondary-bg-color': '#0f4a4d',
    '--text-color': '#f0fdfa',
    '--heading-color': '#ffffff',
    '--accent-color': '#2dd4bf',
    '--accent-hover-color': '#14b8a6',
    '--accent-light-color': '#5eead4',
    '--border-color': '#2d5f64',
    '--shadow-color': '0 0 0',
    '--link-color': '#5eead4',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#134e4a',
    '--success-color': '#4ade80',
    '--warning-color': '#fbbf24',
    '--error-color': '#f87171',
    '--info-color': '#60a5fa',
    '--overlay-color': 'rgba(0,0,0,0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#0f4a4d',
    '--input-bg-color': '#052b2c',
    '--input-border-hover-color': '#2d5f64',
  },
  'Charcoal': {
    '--primary-bg-color': '#0b0f12',
    '--secondary-bg-color': '#1f2937',
    '--text-color': '#f8fafc',
    '--heading-color': '#ffffff',
    '--accent-color': '#c4b5fd',
    '--accent-hover-color': '#a78bfa',
    '--accent-light-color': '#ddd6fe',
    '--border-color': '#4b5563',
    '--shadow-color': '0 0 0',
    '--link-color': '#ddd6fe',
    '--disabled-color': '#9ca3af',
    '--disabled-bg-color': '#374151',
    '--success-color': '#4ade80',
    '--warning-color': '#fbbf24',
    '--error-color': '#f87171',
    '--info-color': '#60a5fa',
    '--overlay-color': 'rgba(0,0,0,0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#1f2937',
    '--input-bg-color': '#0f1416',
    '--input-border-hover-color': '#6b7280',
  },
  'Crimson Night': {
    '--primary-bg-color': '#12060b',
    '--secondary-bg-color': '#3f1725',
    '--text-color': '#fff1f2',
    '--heading-color': '#ffffff',
    '--accent-color': '#fda4af',
    '--accent-hover-color': '#fb7185',
    '--accent-light-color': '#fecdd3',
    '--border-color': '#5f2235',
    '--shadow-color': '0 0 0',
    '--link-color': '#fecdd3',
    '--disabled-color': '#9ca3af',
    '--disabled-bg-color': '#4c1d2f',
    '--success-color': '#4ade80',
    '--warning-color': '#fbbf24',
    '--error-color': '#fca5a5',
    '--info-color': '#60a5fa',
    '--overlay-color': 'rgba(0,0,0,0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#3f1725',
    '--input-bg-color': '#160814',
    '--input-border-hover-color': '#7f2d47',
  },
  'Midnight Deep': {
    '--primary-bg-color': '#030318',
    '--secondary-bg-color': '#1e1b4b',
    '--text-color': '#f5f5ff',
    '--heading-color': '#ffffff',
    '--accent-color': '#a78bfa',
    '--accent-hover-color': '#8b5cf6',
    '--accent-light-color': '#c4b5fd',
    '--border-color': '#3730a3',
    '--shadow-color': '0 0 0',
    '--link-color': '#c4b5fd',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#312e81',
    '--success-color': '#4ade80',
    '--warning-color': '#fbbf24',
    '--error-color': '#f87171',
    '--info-color': '#60a5fa',
    '--overlay-color': 'rgba(0,0,0,0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#1e1b4b',
    '--input-bg-color': '#0e0c2e',
    '--input-border-hover-color': '#4c1d95',
  },
  'Slate Night': {
    '--primary-bg-color': '#0b1220',
    '--secondary-bg-color': '#1e3a52',
    '--text-color': '#f0f9ff',
    '--heading-color': '#ffffff',
    '--accent-color': '#22d3ee',
    '--accent-hover-color': '#06b6d4',
    '--accent-light-color': '#67e8f9',
    '--border-color': '#334e68',
    '--shadow-color': '0 0 0',
    '--link-color': '#67e8f9',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#1e3a52',
    '--success-color': '#4ade80',
    '--warning-color': '#fbbf24',
    '--error-color': '#f87171',
    '--info-color': '#60a5fa',
    '--overlay-color': 'rgba(0,0,0,0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#1e3a52',
    '--input-bg-color': '#0e1622',
    '--input-border-hover-color': '#475d7a',
  },
  'Coral Dusk (غسق المرجان)': {
    '--primary-bg-color': '#071826',
    '--secondary-bg-color': '#1e4a61',
    '--text-color': '#f0f9ff',
    '--heading-color': '#ffffff',
    '--accent-color': '#ffa68a',
    '--accent-hover-color': '#ff8c6d',
    '--accent-light-color': '#ffc4b0',
    '--border-color': '#2d5f7a',
    '--shadow-color': '0 0 0',
    '--link-color': '#ffc4b0',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#1e4a61',
    '--success-color': '#4ade80',
    '--warning-color': '#fbbf24',
    '--error-color': '#f87171',
    '--info-color': '#60a5fa',
    '--overlay-color': 'rgba(0,0,0,0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#1e4a61',
    '--input-bg-color': '#0f2b3b',
    '--input-border-hover-color': '#3d6d8a',
  },
  'Neon Reef (شعاب المرجان)': {
    '--primary-bg-color': '#041629',
    '--secondary-bg-color': '#1e3a5f',
    '--text-color': '#f0f9ff',
    '--heading-color': '#ffffff',
    '--accent-color': '#d8b4fe',
    '--accent-hover-color': '#c77dff',
    '--accent-light-color': '#e9d5ff',
    '--border-color': '#334e7a',
    '--shadow-color': '0 0 0',
    '--link-color': '#ffc4dd',
    '--disabled-color': '#94a3b8',
    '--disabled-bg-color': '#1e3a5f',
    '--success-color': '#4ade80',
    '--warning-color': '#fbbf24',
    '--error-color': '#f87171',
    '--info-color': '#60a5fa',
    '--overlay-color': 'rgba(0,0,0,0.6)',
    '--text-on-accent-color': '#ffffff',
    '--card-bg-color': '#1e3a5f',
    '--input-bg-color': '#0a2133',
    '--input-border-hover-color': '#475d8a',
  }
};

export const FONT_SIZES = ['13px','14px','15px','16px','18px','20px'];

export const FONT_FAMILIES = [
  "'Tajawal', sans-serif",
  "'Cairo', sans-serif",
  "'Noto Sans Arabic', 'Noto Sans', sans-serif",
  "'El Messiri', sans-serif",
  "'Baloo Bhaijaan 2', cursive",
  "'Lalezar', cursive",
  "'Vazirmatn', sans-serif",
  "'Poppins', 'Noto Sans Arabic', sans-serif",
  "'Montserrat', 'Mada', sans-serif",
];

// Unified settings interface
export interface AppSettings {
  fontSize: string;
  fontFamily: string;
  lightPalette: string;
  darkPalette: string;
  recars_preferred_layout: string;
  recars_view_mode: string;
}

// Default settings
const DEFAULT_SETTINGS: AppSettings = {
  fontSize: '16px',
  fontFamily: "'Tajawal', sans-serif",
  lightPalette: 'default',
  darkPalette: 'default',
  recars_preferred_layout: 'grid',
  recars_view_mode: 'card'
};

// Get settings from localStorage
export function getSettings(): AppSettings {
  try {
    const stored = localStorage.getItem('app-settings');
    if (stored) {
      return { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
    }
  } catch (error) {
    console.error('Error loading settings:', error);
  }
  return DEFAULT_SETTINGS;
}

// Save settings to localStorage
export function saveSettings(settings: Partial<AppSettings>): void {
  try {
    const current = getSettings();
    const updated = { ...current, ...settings };
    localStorage.setItem('app-settings', JSON.stringify(updated));
  } catch (error) {
    console.error('Error saving settings:', error);
  }
}

// Convert #rrggbb to H S% L% string used by legacy variables in index.css
export function hexToHsl(hex: string): string {
  if (!hex || hex[0] !== '#') return hex;
  const h = hex.replace('#', '');
  const r = parseInt(h.substring(0,2), 16) / 255;
  const g = parseInt(h.substring(2,4), 16) / 255;
  const b = parseInt(h.substring(4,6), 16) / 255;
  const max = Math.max(r,g,b), min = Math.min(r,g,b);
  let hh = 0, s = 0, l = (max + min) / 2;
  if (max !== min) {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch(max) {
      case r: hh = (g - b) / d + (g < b ? 6 : 0); break;
      case g: hh = (b - r) / d + 2; break;
      case b: hh = (r - g) / d + 4; break;
    }
    hh /= 6;
  }
  const hue = Math.round(hh * 360);
  const sat = Math.round(s * 100);
  const lig = Math.round(l * 100);
  return `${hue} ${sat}% ${lig}%`;
}

export function applyPaletteVars(vars: Record<string,string>): void {
  const el = document.documentElement;
  for (const k in vars) el.style.setProperty(k, vars[k]);
}

export function applyBoth(vars: Record<string,string>): void {
  applyPaletteVars(vars);
  const el = document.documentElement;
  
  // Map palette variables to the actual CSS variables used by components
  if (vars['--primary-bg-color']) {
    el.style.setProperty('--app-bg', hexToHsl(vars['--primary-bg-color']));
    el.style.setProperty('--background', hexToHsl(vars['--primary-bg-color']));
  }
  if (vars['--secondary-bg-color']) {
    el.style.setProperty('--app-surface', hexToHsl(vars['--secondary-bg-color']));
    el.style.setProperty('--card', hexToHsl(vars['--secondary-bg-color']));
  }
  if (vars['--text-color']) {
    el.style.setProperty('--app-text', hexToHsl(vars['--text-color']));
    el.style.setProperty('--foreground', hexToHsl(vars['--text-color']));
  }
  if (vars['--accent-color']) {
    el.style.setProperty('--app-primary', hexToHsl(vars['--accent-color']));
    el.style.setProperty('--app-accent', hexToHsl(vars['--accent-color']));
    el.style.setProperty('--primary', hexToHsl(vars['--accent-color']));
    el.style.setProperty('--ring', hexToHsl(vars['--accent-color']));
  }
  if (vars['--border-color']) {
    el.style.setProperty('--app-border', hexToHsl(vars['--border-color']));
    el.style.setProperty('--border', hexToHsl(vars['--border-color']));
  }
  if (vars['--shadow-color']) {
    el.style.setProperty('--shadow-color', vars['--shadow-color']);
  }
  
  // New extended variables
  if (vars['--disabled-color']) {
    el.style.setProperty('--app-disabled', hexToHsl(vars['--disabled-color']));
  }
  if (vars['--disabled-bg-color']) {
    el.style.setProperty('--app-disabled-bg', hexToHsl(vars['--disabled-bg-color']));
  }
  if (vars['--success-color']) {
    el.style.setProperty('--app-success', hexToHsl(vars['--success-color']));
  }
  if (vars['--warning-color']) {
    el.style.setProperty('--app-warning', hexToHsl(vars['--warning-color']));
  }
  if (vars['--error-color']) {
    el.style.setProperty('--app-error', hexToHsl(vars['--error-color']));
  }
  if (vars['--info-color']) {
    el.style.setProperty('--app-info', hexToHsl(vars['--info-color']));
  }
  if (vars['--card-bg-color']) {
    el.style.setProperty('--app-card-bg', hexToHsl(vars['--card-bg-color']));
  }
  if (vars['--input-bg-color']) {
    el.style.setProperty('--app-input-bg', hexToHsl(vars['--input-bg-color']));
  }
  if (vars['--input-border-hover-color']) {
    el.style.setProperty('--app-input-border-hover', hexToHsl(vars['--input-border-hover-color']));
  }
}

export function applyAll(mode: 'light'|'dark', pal: string, fSize: string, fFamily: string): void {
  const el = document.documentElement;
  if (mode === 'dark') el.classList.add('dark'); else el.classList.remove('dark');
  const themeGroup = mode === 'dark' ? DARK_THEMES : LIGHT_THEMES;
  
  // Determine which palette to use
  let paletteVars: Record<string, string>;
  if (!pal || pal === 'default') {
    // Use default palette for the current mode
    const defaultPalette = mode === 'dark' ? 'Night Indigo' : 'Light Blue';
    paletteVars = themeGroup[defaultPalette];
  } else {
    // Use the selected palette if it exists, otherwise fallback to default
    paletteVars = themeGroup[pal];
    if (!paletteVars) {
      const defaultPalette = mode === 'dark' ? 'Night Indigo' : 'Light Blue';
      paletteVars = themeGroup[defaultPalette];
    }
  }
  
  applyBoth(paletteVars);
  el.style.setProperty('--base-font-size', fSize);
  el.style.setProperty('--font-family', fFamily);
}

// Initialize theme on app load
export function initTheme(): void {
  const settings = getSettings();
  
  // Get theme from theme-provider (it manages dark/light mode)
  const isDark = document.documentElement.classList.contains('dark');
  const mode = isDark ? 'dark' : 'light';
  
  // Use mode-specific palette
  const palette = mode === 'dark' ? settings.darkPalette : settings.lightPalette;
  const paletteToApply = palette === 'default' ? '' : palette;
  
  applyAll(mode, paletteToApply, settings.fontSize, settings.fontFamily);
}
